# تحسينات تصدير تقارير CSV - نظام إدارة المدارس الخاصة

## نظرة عامة

تم تحسين وظيفة تصدير تقارير CSV في جميع صفحات النظام لتوفير تجربة مستخدم أفضل وتقارير أكثر احترافية.

## 🎯 الهدف من التحسينات

1. **السماح للمستخدم باختيار مكان الحفظ**: بدلاً من الحفظ التلقائي في مجلد محدد
2. **أسماء ملفات افتراضية باللغة الإنجليزية**: مع التاريخ والوقت الدقيق
3. **تحسين التنسيق للعرض في Excel**: مع إحصائيات مفصلة وترويسة احترافية
4. **دعم الأحرف العربية**: مع ترميز UTF-8-BOM للعرض الصحيح في Excel

## 📋 الصفحات المُحسنة

### 1. صفحة الواردات الخارجية (`external_income_page.py`)
- **اسم الملف الافتراضي**: `External_Income_Report_YYYYMMDD_HHMMSS.csv`
- **البيانات المُصدرة**: المعرف، نوع الوارد، الوصف، المبلغ، الفئة، التاريخ، المدرسة، الملاحظات
- **الإحصائيات**: إجمالي السجلات، إجمالي المبلغ، متوسط المبلغ، أكبر وأصغر مبلغ

### 2. صفحة المصروفات (`expenses_page.py`)
- **اسم الملف الافتراضي**: `Expenses_Report_YYYYMMDD_HHMMSS.csv`
- **البيانات المُصدرة**: المعرف، نوع المصروف، المبلغ، الوصف، التاريخ، المدرسة، الملاحظات
- **الإحصائيات**: إجمالي السجلات، إجمالي المبلغ، متوسط المبلغ، أكبر وأصغر مبلغ

### 3. صفحة الرسوم الإضافية (`additional_fees_page.py`)
- **اسم الملف الافتراضي**: `Additional_Fees_Report_YYYYMMDD_HHMMSS.csv`
- **البيانات المُصدرة**: المعرف، اسم الطالب، المدرسة، نوع الرسم، المبلغ، حالة الدفع، تاريخ الدفع، الملاحظات، تاريخ الإنشاء
- **الإحصائيات**: إجمالي السجلات، إجمالي المبلغ، المبلغ المدفوع، المبلغ المتبقي، عدد الرسوم المدفوعة وغير المدفوعة

## 🛠️ التحسينات التقنية

### 1. واجهة المستخدم
- إضافة `QFileDialog` لاختيار مكان الحفظ
- رسالة تأكيد مع خيار فتح الملف فوراً
- التحقق من وجود البيانات قبل التصدير
- إضافة امتداد `.csv` تلقائياً إذا لم يكتبه المستخدم

### 2. تحسينات التنسيق
- استخدام `csv.writer` مع إعدادات محسنة
- ترميز `utf-8-sig` لدعم الأحرف العربية في Excel
- فصل البيانات بالفواصل مع حماية النصوص
- تنسيق الأرقام مع فواصل الآلاف

### 3. هيكل التقرير
```csv
تقرير [نوع التقرير] - YYYY-MM-DD HH:MM
إجمالي عدد [العناصر]: XX
إجمالي المبلغ: XXX,XXX.XX د.ع
[معلومات إضافية حسب نوع التقرير]

[رؤوس الأعمدة بالإنجليزية]
[البيانات]

Statistics:
Total Records: XX
Total Amount: XXX,XXX.XX IQD
Average Amount: XXX,XXX.XX IQD
Max Amount: XXX,XXX.XX IQD
Min Amount: XXX,XXX.XX IQD
[إحصائيات إضافية حسب نوع التقرير]
```

## 🚀 طريقة الاستخدام

1. **في أي صفحة من الصفحات المُحسنة**:
   - اختر الفلاتر المطلوبة (تاريخ، مدرسة، فئة، إلخ)
   - اضغط على زر "تصدير التقرير"

2. **نافذة حفظ الملف**:
   - سيظهر اسم الملف الافتراضي بصيغة إنجليزية مع التاريخ والوقت
   - يمكنك تغيير الاسم والمكان حسب الرغبة
   - اضغط "حفظ"

3. **بعد التصدير**:
   - سيظهر مربع حوار يؤكد نجاح العملية
   - خيار فتح الملف فوراً في Excel
   - إذا اخترت "نعم" سيُفتح الملف تلقائياً

## 📊 مميزات Excel المُحسنة

- **عرض صحيح للأحرف العربية**: بفضل ترميز UTF-8-BOM
- **تنسيق احترافي**: مع ترويسة معلومات وإحصائيات في النهاية
- **أرقام منسقة**: مع فواصل الآلاف لسهولة القراءة
- **أعمدة منظمة**: برؤوس واضحة باللغة الإنجليزية
- **إحصائيات تفصيلية**: في نهاية كل تقرير

## 🧪 اختبار التحسينات

### اختبار سريع لوظيفة واحدة:
```bash
python test_export.py
```

### اختبار شامل لجميع الوظائف:
```bash
python test_all_exports.py
```

## 📁 الملفات المُعدلة

1. `ui/pages/external_income/external_income_page.py`
2. `ui/pages/expenses/expenses_page.py`
3. `ui/pages/additional_fees/additional_fees_page.py`

## 📝 ملاحظات مهمة

1. **الاستيرادات**: تم إضافة `QFileDialog` و `csv` لجميع الملفات
2. **الترميز**: جميع الملفات تُحفظ بترميز `utf-8-sig`
3. **معالجة الأخطاء**: تم تحسين رسائل الخطأ لتكون أكثر وضوحاً
4. **الأداء**: التحقق من وجود البيانات قبل بدء عملية التصدير

## 🔮 تحسينات مستقبلية محتملة

1. **تصدير بصيغة Excel (.xlsx)**: لتنسيق أكثر تطوراً
2. **تصدير بصيغة PDF**: للتقارير المطبوعة
3. **قوالب تصدير مخصصة**: يمكن للمستخدم اختيارها
4. **جدولة التصدير التلقائي**: لتقارير دورية
5. **ضغط الملفات**: للتقارير الكبيرة

---

**تاريخ التحديث**: أغسطس 2025  
**الإصدار**: 1.0  
**المطور**: فريق تطوير نظام إدارة المدارس الخاصة
