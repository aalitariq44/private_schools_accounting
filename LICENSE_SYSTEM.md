# نظام التراخيص - دليل المطور

## نظرة عامة
تم تطوير نظام تراخيص متكامل لحماية التطبيق من المشاركة غير المرخصة. النظام يعمل بالشكل التالي:

## مكونات النظام

### 1. جمع معلومات الهارد وير (`hardware_info.py`)
- **اللوحة الأم (Motherboard)**: رقم سيريال اللوحة الأم
- **المعالج (CPU)**: معرف المعالج الفريد  
- **عنوان MAC**: عنوان الشبكة للجهاز
- **القرص الصلب (Drive)**: رقم سيريال القرص الصلب الرئيسي

### 2. إدارة التراخيص (`license_manager.py`)
- التحقق من رموز التفعيل عبر Supabase
- إنشاء ملف ترخيص محلي مشفر
- مقارنة معلومات الهارد وير
- التعامل مع التراخيص المستخدمة سابقاً

### 3. واجهة التفعيل (`activation_dialog.py`)
- نافذة منبثقة لإدخال رمز التفعيل
- معالجة عملية التفعيل في خيط منفصل
- عرض رسائل الخطأ والنجاح

### 4. نظام الترخيص الشامل (`license_system.py`)
- تكامل جميع المكونات
- فحص الترخيص عند بدء التطبيق
- معالجة الحالات المختلفة

## آلية العمل

### عند كل تشغيل للتطبيق:

1. **فحص وجود ملف الترخيص**:
   - إذا وُجد: فك التشفير والتحقق من صحة البيانات
   - إذا لم يوجد: عرض نافذة التفعيل

2. **مقارنة معلومات الهارد وير**:
   - يجب تطابق على الأقل 2 من 4 عناصر للسماح بالتشغيل
   - إذا تطابق 3-4 عناصر: تشغيل عادي
   - إذا تطابق أقل من 2: رفض التشغيل

### عند التفعيل لأول مرة:

1. **إدخال رمز التفعيل**
2. **التحقق من الرمز في Supabase**:
   - إذا كان غير مستخدم: تفعيل جديد
   - إذا كان مستخدماً: التحقق من تطابق الجهاز

3. **حفظ ملف الترخيص المحلي المشفر**

## جدول licenses في Supabase

```sql
CREATE TABLE licenses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    activation_code TEXT UNIQUE NOT NULL,
    used BOOLEAN DEFAULT FALSE,
    issued_to JSONB,
    issued_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    revoked BOOLEAN DEFAULT FALSE,
    last_checkin_at TIMESTAMP WITH TIME ZONE,
    notes TEXT,
    motherboard TEXT,
    cpu TEXT,
    mac TEXT,
    drive TEXT,
    first_used_at TIMESTAMP WITH TIME ZONE
);
```

## ملف الترخيص المحلي

يتم حفظ ملف `license.json` في مجلد التطبيق الرئيسي مع تشفير قوي:

```json
{
  "activation_code": "رمز التفعيل",
  "hardware_info": {
    "motherboard": "رقم اللوحة الأم",
    "cpu": "معرف المعالج", 
    "mac": "عنوان MAC",
    "drive": "رقم القرص الصلب"
  },
  "first_used_at": "تاريخ أول استخدام",
  "issued_to": "معلومات المستخدم",
  "notes": "ملاحظات",
  "created_at": "تاريخ إنشاء الملف"
}
```

## حالات التشغيل

### الحالة 1: ملف الترخيص موجود وصحيح
- تطابق 4/4 أو 3/4 عناصر ← تشغيل عادي
- تطابق 2/4 عناصر ← تشغيل مع تحذير في السجل
- تطابق أقل من 2/4 ← رفض التشغيل

### الحالة 2: ملف الترخيص غير موجود
- عرض نافذة التفعيل
- التحقق من رمز التفعيل عبر الإنترنت
- إنشاء ملف ترخيص جديد

### الحالة 3: ملف الترخيص تالف
- حذف الملف التالف
- عرض نافذة التفعيل

## الأمان

1. **التشفير**: استخدام Fernet encryption مع مفتاح ثابت
2. **التحقق المتعدد**: 4 عناصر هارد وير مختلفة
3. **المرونة**: السماح بتغيير جزئي في الهارد وير
4. **الحماية من التلاعب**: تشفير قوي لملف الترخيص

## استخدام النظام

### في main.py:
```python
from core.licensing import initialize_license_system

# في دالة run()
success, license_system = initialize_license_system(self.app)
if not success:
    return 0  # خروج من التطبيق
```

### فحص سريع للترخيص:
```python
from core.licensing import quick_license_check

if not quick_license_check():
    print("الترخيص غير صالح")
```

## اختبار النظام

تشغيل اختبار النظام:
```bash
python test_license.py
```

## ملاحظات مهمة

1. **مفتاح التشفير**: ثابت لجميع المستخدمين في الكود
2. **الاتصال بالإنترنت**: مطلوب فقط للتفعيل الأول
3. **النسخ الاحتياطية**: ملف الترخيص غير مشمول في النسخ الاحتياطية
4. **التحديثات**: النظام متوافق مع تحديثات التطبيق

## استكشاف الأخطاء

### خطأ في فك التشفير:
- حذف ملف license.json وإعادة التفعيل

### عدم تطابق الهارد وير:
- فحص التغييرات في مكونات الجهاز
- التواصل مع الدعم لإعادة التفعيل

### مشاكل الاتصال:
- التحقق من الاتصال بالإنترنت
- التحقق من إعدادات Supabase
