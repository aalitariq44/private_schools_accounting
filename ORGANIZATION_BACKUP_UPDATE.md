# تحديث نظام النسخ الاحتياطي مع إضافة اسم المؤسسة

## نظرة عامة على التحديث

تم تطوير نظام النسخ الاحتياطي ليشمل ميزة جديدة لإدارة أسماء المؤسسات وتنظيم النسخ الاحتياطية بناءً على اسم كل مؤسسة.

## الميزات الجديدة

### 1. إعداد اسم المؤسسة في التشغيل الأولي

- **الموقع**: `ui/auth/first_setup_dialog.py`
- **الوصف**: تم إضافة حقل جديد لإدخال اسم المؤسسة في نافذة الإعداد الأولي
- **المتطلبات**:
  - اسم المؤسسة إجباري (الحد الأدنى 3 أحرف)
  - يتم حفظه مرة واحدة فقط ولا يمكن تعديله لاحقاً
  - يتم عرضه في صفحة الإعدادات للمراجعة فقط

### 2. تحديث إدارة الإعدادات

- **الموقع**: `core/utils/settings_manager.py`
- **التحديثات**:
  - إضافة دوال `get_organization_name()` و `set_organization_name()`
  - إضافة اسم المؤسسة للإعدادات الافتراضية
  - دالة مساعدة `get_organization_name()` للاستخدام العام

### 3. نظام النسخ الاحتياطي المحدث

- **الموقع**: `core/backup/backup_manager.py`
- **التحديثات الرئيسية**:

#### هيكل المجلدات الجديد:
```
backups/
├── اسم_المؤسسة_الأولى/
│   ├── backup_20250812_143022.zip
│   ├── backup_20250812_150045.zip
│   └── backup_20250812_162110.zip
├── اسم_المؤسسة_الثانية/
│   ├── backup_20250812_140030.zip
│   └── backup_20250812_155520.zip
└── اسم_المؤسسة_الثالثة/
    └── backup_20250812_120015.zip
```

#### الميزات:
- **مجلد منفصل لكل مؤسسة**: كل مؤسسة لها مجلد منفصل باسمها
- **تنظيف أسماء المجلدات**: إزالة الأحرف الخاصة واستبدالها بـ `_`
- **أسماء الملفات بالتاريخ والوقت**: `backup_YYYYMMDD_HHMMSS.zip`
- **التوافق مع النظام القديم**: يمكن قراءة النسخ القديمة

### 4. تحديث صفحة الإعدادات

- **الموقع**: `ui/pages/settings/settings_page.py`
- **التحديثات**:
  - إضافة قسم "معلومات المؤسسة"
  - عرض اسم المؤسسة (قراءة فقط)
  - رسالة توضيحية أن الاسم لا يمكن تغييره

### 5. تحديث التطبيق الرئيسي

- **الموقع**: `main.py`
- **التحديثات**:
  - التحقق من وجود اسم المؤسسة عند بدء التشغيل
  - طلب إدخال اسم المؤسسة للمستخدمين الحاليين (إذا لم يكن موجوداً)
  - حفظ اسم المؤسسة مع إنشاء المستخدم الأول

## كيفية عمل النظام الجديد

### عند التشغيل لأول مرة:
1. يظهر للمستخدم نافذة الإعداد الأولي
2. يُطلب إدخال اسم المؤسسة (إجباري)
3. يُطلب إدخال كلمة المرور
4. يتم حفظ اسم المؤسسة في قاعدة البيانات
5. يتم إنشاء المستخدم الأول

### عند إنشاء نسخة احتياطية:
1. يتم استرجاع اسم المؤسسة من الإعدادات
2. يتم تنظيف الاسم ليكون آمناً كاسم مجلد
3. يتم إنشاء مسار: `backups/اسم_المؤسسة_الآمن/backup_تاريخ_وقت.zip`
4. يتم رفع النسخة إلى Supabase في المجلد المخصص

### عند عرض قائمة النسخ الاحتياطية:
1. يتم البحث في مجلد المؤسسة الحالية أولاً
2. إذا لم توجد نسخ، يتم البحث في النظام القديم للتوافق
3. يتم عرض النسخ مرتبة حسب التاريخ (الأحدث أولاً)

## الفوائد

### 1. الفصل بين المؤسسات:
- كل مؤسسة لها مجلد منفصل
- لا يوجد تداخل أو خلط في النسخ الاحتياطية
- سهولة إدارة النسخ لكل مؤسسة

### 2. سهولة التنظيم:
- أسماء ملفات واضحة بالتاريخ والوقت
- مجلد واحد لكل مؤسسة بدون تداخل
- سهولة العثور على النسخ المطلوبة

### 3. الأمان:
- اسم المؤسسة لا يمكن تغييره بعد الإعداد الأولي
- كل مؤسسة محمية في مجلدها الخاص
- لا يمكن للمؤسسات الأخرى الوصول لنسخ المؤسسات الأخرى

### 4. التوافق:
- النظام يدعم النسخ القديمة
- يمكن الترقية تدريجياً
- لا يؤثر على البيانات الموجودة

## ملاحظات مهمة

### للمطورين:
- تأكد من استدعاء `settings_manager.get_organization_name()` للحصول على اسم المؤسسة
- استخدم تنظيف الأسماء قبل إنشاء المجلدات
- تعامل مع حالة عدم وجود اسم المؤسسة

### للمستخدمين:
- اسم المؤسسة يُطلب مرة واحدة فقط
- اختر اسماً واضحاً ومميزاً للمؤسسة
- الاسم سيظهر في صفحة الإعدادات للمراجعة

### للصيانة:
- يمكن عرض جميع المؤسسات من مجلد `backups/` في Supabase
- كل مجلد فرعي يمثل مؤسسة مختلفة
- يمكن إدارة النسخ لكل مؤسسة بشكل منفصل

## اختبار النظام

تم إنشاء ملف اختبار `test_organization_backup.py` يتضمن:
- اختبار إعدادات المؤسسة
- اختبار تنظيف أسماء المجلدات
- اختبار النسخ الاحتياطية مع المجلد الجديد

لتشغيل الاختبار:
```bash
python test_organization_backup.py
```

## ملفات التحديث

### الملفات المُعدّلة:
1. `ui/auth/first_setup_dialog.py` - إضافة حقل اسم المؤسسة
2. `core/utils/settings_manager.py` - إدارة إعدادات المؤسسة
3. `core/backup/backup_manager.py` - نظام النسخ الاحتياطي الجديد
4. `ui/pages/settings/settings_page.py` - عرض اسم المؤسسة
5. `main.py` - التحقق من اسم المؤسسة عند البدء

### الملفات الجديدة:
1. `test_organization_backup.py` - ملف اختبار النظام
2. `ORGANIZATION_BACKUP_UPDATE.md` - توثيق التحديث

## الخطوات التالية (اختيارية)

1. **إضافة ميزة تصدير النسخ**: إمكانية تحميل جميع نسخ المؤسسة
2. **إحصائيات النسخ**: عرض عدد وحجم النسخ لكل مؤسسة
3. **إدارة متقدمة**: أدوات إدارية لعرض جميع المؤسسات
4. **تشفير أسماء المؤسسات**: للحماية الإضافية في التخزين السحابي
