# ميزة النسخ الاحتياطي التلقائي عند الخروج

## 🎯 الهدف من الميزة

تقوم هذه الميزة بإنشاء نسخة احتياطية تلقائية من قاعدة البيانات عند إغلاق التطبيق، مما يضمن عدم فقدان البيانات المهمة.

## 🔧 كيفية العمل

### آلية النسخ الاحتياطي السريع الموجودة:

1. **BackupManager** في `core/backup/backup_manager.py`:
   - ينشئ ملف ZIP يحتوي على قاعدة البيانات
   - يضيف معلومات النسخة (التاريخ، الوصف، حجم الملف)
   - يرفع الملف على Supabase Storage في مجلد خاص بالمؤسسة

2. **دالة النسخ السريع** في `app/main_window.py`:
   - `create_quick_backup()`: للنسخ اليدوي
   - `create_auto_backup_on_exit()`: للنسخ التلقائي عند الخروج

### الميزة الجديدة:

1. **closeEvent()** المُحدثة:
   - تتحقق من إعدادات النسخ الاحتياطي التلقائي
   - تعرض رسالة تأكيد مخصصة حسب الإعدادات
   - تنشئ نسخة احتياطية تلقائية قبل الإغلاق
   - تتعامل مع حالات الفشل بشكل ذكي

2. **create_auto_backup_on_exit()**:
   - تنشئ وصف تلقائي مع التاريخ والوقت
   - تعرض شريط تقدم مخصص للخروج
   - تعرض رسالة نجاح (اختيارية حسب الإعدادات)
   - تتعامل مع الأخطاء وتعطي المستخدم خيارات

## ⚙️ الإعدادات

تم إضافة ثلاث إعدادات جديدة في `config.py`:

```python
# إعدادات النسخ الاحتياطي التلقائي عند الخروج
AUTO_BACKUP_ON_EXIT = True  # تفعيل النسخ الاحتياطي التلقائي عند إغلاق التطبيق
AUTO_BACKUP_SHOW_SUCCESS_MESSAGE = True  # عرض رسالة نجاح النسخ الاحتياطي
AUTO_BACKUP_CONFIRMATION_DIALOG = True  # عرض حوار تأكيد قبل الخروج
```

### شرح الإعدادات:

1. **AUTO_BACKUP_ON_EXIT**:
   - `True`: تفعيل النسخ الاحتياطي التلقائي
   - `False`: إلغاء تفعيل الميزة (يعمل التطبيق كما كان سابقاً)

2. **AUTO_BACKUP_SHOW_SUCCESS_MESSAGE**:
   - `True`: عرض رسالة نجاح لمدة ثانيتين
   - `False`: عدم عرض رسالة النجاح (أسرع في الإغلاق)

3. **AUTO_BACKUP_CONFIRMATION_DIALOG**:
   - `True`: عرض إشعار في حوار التأكيد بأنه سيتم إنشاء نسخة احتياطية
   - `False`: حوار تأكيد عادي بدون إشعار

## 🚀 كيفية الاستخدام

### للمستخدم النهائي:

1. قم بتشغيل التطبيق كالمعتاد
2. عند الضغط على إغلاق التطبيق (X) أو اختيار "خروج":
   - سيظهر حوار تأكيد مع إشعار النسخ الاحتياطي التلقائي
   - اضغط "نعم" للمتابعة
   - سيبدأ إنشاء النسخة الاحتياطية تلقائياً
   - سيتم عرض شريط تقدم أثناء العملية
   - (اختياري) رسالة نجاح سريعة
   - إغلاق التطبيق

### للمطور:

```python
# في main_window.py

# النسخ الاحتياطي اليدوي (الموجود سابقاً)
self.create_quick_backup()

# النسخ الاحتياطي التلقائي عند الخروج (جديد)
backup_success = self.create_auto_backup_on_exit()
if backup_success is False:
    # المستخدم لا يريد الخروج بدون نسخة احتياطية
    return
```

## 📝 أمثلة على السيناريوهات

### السيناريو 1: إعدادات افتراضية (كل شيء مفعل)
```
المستخدم يضغط X → حوار تأكيد مع إشعار النسخ → نعم → شريط تقدم → رسالة نجاح لثانيتين → إغلاق
```

### السيناريو 2: نسخ احتياطي صامت
```python
AUTO_BACKUP_ON_EXIT = True
AUTO_BACKUP_SHOW_SUCCESS_MESSAGE = False
AUTO_BACKUP_CONFIRMATION_DIALOG = False
```
```
المستخدم يضغط X → حوار تأكيد عادي → نعم → شريط تقدم → إغلاق فوري
```

### السيناريو 3: معطل تماماً
```python
AUTO_BACKUP_ON_EXIT = False
```
```
المستخدم يضغط X → حوار تأكيد عادي → نعم → إغلاق فوري (كما كان سابقاً)
```

### السيناريو 4: فشل النسخ الاحتياطي
```
المستخدم يضغط X → حوار تأكيد → نعم → شريط تقدم → فشل → حوار خيارات:
"فشل النسخ الاحتياطي، هل تريد الخروج بدونه؟" → نعم/لا
```

## 🛠️ التحديثات المُطبقة

### 1. تحديث `config.py`
```python
# إضافة إعدادات جديدة
AUTO_BACKUP_ON_EXIT = True
AUTO_BACKUP_SHOW_SUCCESS_MESSAGE = True  
AUTO_BACKUP_CONFIRMATION_DIALOG = True
```

### 2. تحديث `app/main_window.py`

#### إضافة دالة جديدة:
- `create_auto_backup_on_exit()`: النسخ التلقائي عند الخروج

#### تحديث دوال موجودة:
- `closeEvent()`: معالجة ذكية للإغلاق مع النسخ التلقائي

### 3. إضافة ملف اختبار
- `test_auto_backup_on_exit.py`: اختبار شامل للميزة الجديدة

## 🧪 الاختبار

يمكنك اختبار الميزة بتشغيل:

```bash
python test_auto_backup_on_exit.py
```

سيقوم بـ:
- اختبار الإعدادات
- اختبار مدير النسخ الاحتياطي
- اختبار دوال النافذة الرئيسية
- اختبار سيناريوهات مختلفة للإعدادات

## 🔒 الأمان والموثوقية

1. **معالجة الأخطاء**:
   - في حالة فشل النسخ، يُعطى المستخدم خيار
   - إذا كان النظام معطل، لا يتوقف الإغلاق
   - جميع الأخطاء مسجلة في سجلات التطبيق

2. **تجربة المستخدم**:
   - واجهة واضحة ومفهومة
   - إشعارات مناسبة لكل حالة
   - إمكانية إلغاء الإغلاق إذا فشل النسخ

3. **الأداء**:
   - النسخ الاحتياطي سريع (ثوانٍ قليلة)
   - لا يؤثر على سرعة التطبيق
   - معالجة غير متزامنة للواجهة

## 📊 مراقبة الاستخدام

كل عملية نسخ احتياطي تلقائي تُسجل في:
- سجلات التطبيق (`logs/`)
- سجل أنشطة المستخدم مع وصف: `"backup auto-exit"`

## 🎨 التخصيص

يمكن تخصيص الميزة عبر:

1. **تعديل الرسائل**: في `create_auto_backup_on_exit()`
2. **تعديل التوقيت**: متغير `QTimer.singleShot(2000, ...)`
3. **تعديل الوصف**: تنسيق `description` في الدالة
4. **إضافة إعدادات جديدة**: في `config.py`

## 🏁 الخلاصة

تم تنفيذ ميزة النسخ الاحتياطي التلقائي عند الخروج بنجاح مع:

✅ **المميزات**:
- نسخ احتياطي تلقائي قبل الإغلاق
- إعدادات قابلة للتخصيص
- معالجة ذكية للأخطاء
- واجهة مستخدم واضحة
- عدم تأثير على الوظائف الحالية

✅ **المرونة**:
- يمكن تفعيلها أو إلغاؤها
- خيارات متعددة للعرض
- تتكيف مع حالات مختلفة

✅ **الأمان**:
- النسخ آمن على Supabase
- معالجة جميع حالات الفشل
- عدم فقدان البيانات

الميزة جاهزة للاستخدام وتعمل بسلاسة مع النظام الحالي! 🎉
