# تحسينات تصدير تقارير CSV

## التحسينات التي تمت

### 1. اختيار مكان التخزين واسم الملف

- **قبل التحسين**: كان يتم حفظ الملف تلقائياً في مجلد `data/exports/reports` بدون اختيار المستخدم
- **بعد التحسين**: 
  - يُفتح مربع حوار لاختيار مكان الحفظ
  - اسم الملف الافتراضي: `External_Income_Report_YYYYMMDD_HHMMSS.csv` أو `Expenses_Report_YYYYMMDD_HHMMSS.csv`
  - يمكن للمستخدم تغيير الاسم والمكان حسب الرغبة

### 2. تحسين التنسيق للعرض في Excel

#### التحسينات الجديدة:
1. **ترويسة المعلومات**: 
   - عنوان التقرير مع التاريخ والوقت
   - إجمالي عدد السجلات
   - إجمالي المبلغ

2. **رؤوس الأعمدة بالإنجليزية**:
   - أسماء واضحة ومفهومة دولياً
   - تنسيق متسق عبر جميع التقارير

3. **تنسيق الأرقام**:
   - إضافة فواصل الآلاف للمبالغ (مثل: 1,250.50)
   - تحديد عملة الدينار العراقي (IQD)

4. **إحصائيات تفصيلية في نهاية التقرير**:
   - إجمالي السجلات
   - إجمالي المبلغ
   - متوسط المبلغ
   - أكبر مبلغ
   - أصغر مبلغ

5. **ترميز Unicode محسن**:
   - استخدام `utf-8-sig` لضمان عرض الأحرف العربية بشكل صحيح
   - استخدام `csv.writer` مع تنسيق محدد للحقول

### 3. ميزات إضافية

1. **التحقق من وجود البيانات**: عرض تحذير إذا لم توجد بيانات للتصدير
2. **إضافة امتداد الملف تلقائياً**: إذا لم يكتب المستخدم `.csv`
3. **خيار فتح الملف مباشرة**: سؤال المستخدم إذا كان يريد فتح الملف في Excel
4. **معالجة الأخطاء المحسنة**: رسائل خطأ واضحة ومفيدة

## الاستخدام

### في صفحة الواردات الخارجية:
1. اختر الفلاتر المطلوبة (المدرسة، الفئة، التاريخ، إلخ)
2. اضغط على زر "تصدير التقرير"
3. اختر مكان الحفظ واسم الملف
4. اختر ما إذا كنت تريد فتح الملف مباشرة

### في صفحة المصروفات:
1. اختر الفلاتر المطلوبة
2. اضغط على زر "تصدير التقرير"
3. اختر مكان الحفظ واسم الملف
4. اختر ما إذا كنت تريد فتح الملف مباشرة

## هيكل ملف CSV الجديد

```
تقرير الواردات الخارجية - 2025-08-21 20:45
إجمالي عدد الواردات: 15
إجمالي المبلغ: 1,250,000.00 د.ع

ID,Income Type,Description,Amount (IQD),Category,Date,School,Notes
1,رسوم الحانوت,بيع الأدوات المدرسية,"50,000.00",الحانوت,2025-01-15,مدرسة النور,دفعة شهر يناير
2,رسوم النقل,رسوم نقل الطلاب,"75,000.00",النقل,2025-01-20,مدرسة الأمل,خدمة النقل الشهرية
...

Statistics:
Total Records:,15
Total Amount:,"1,250,000.00 IQD"
Average Amount:,"83,333.33 IQD"
Max Amount:,"150,000.00 IQD"
Min Amount:,"25,000.00 IQD"
```

## ملاحظات تقنية

- يتم حفظ الملفات بترميز `UTF-8 with BOM` لضمان عرض الأحرف العربية في Excel
- استخدام `csv.QUOTE_MINIMAL` لتحسين التنسيق
- فصل البيانات بفواصل مع حماية النصوص التي تحتوي على فواصل
- إضافة أسطر فارغة لتحسين القراءة

## الاختبار

يمكن اختبار التنسيق الجديد عبر تشغيل:
```bash
python test_export.py
```

هذا سيُنشئ ملف CSV نموذجي بالتنسيق الجديد لمراجعة الشكل في Excel.
